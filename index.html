<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>EDC Poster Generator</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      min-height: 100vh;
      padding: 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .container {
      background: rgba(255, 255, 255, 0.95);
      border-radius: 20px;
      padding: 30px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
      backdrop-filter: blur(10px);
      max-width: 900px;
      width: 100%;
    }

    h1 {
      color: #333;
      margin-bottom: 30px;
      font-size: 2.5rem;
      font-weight: 300;
      text-align: center;
      background: linear-gradient(45deg, #667eea, #764ba2);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .upload-section {
      text-align: center;
      margin-bottom: 30px;
    }

    .upload-wrapper {
      position: relative;
      display: inline-block;
      margin-bottom: 20px;
    }

    #uploadImage {
      position: absolute;
      opacity: 0;
      width: 100%;
      height: 100%;
      cursor: pointer;
    }

    .upload-btn {
      display: inline-block;
      padding: 15px 30px;
      background: linear-gradient(45deg, #667eea, #764ba2);
      color: white;
      border: none;
      border-radius: 50px;
      cursor: pointer;
      font-size: 16px;
      font-weight: 500;
      transition: all 0.3s ease;
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
    }

    .upload-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(102, 126, 234, 0.6);
    }

    .controls {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 10px;
      margin: 20px 0;
    }

    .btn {
      padding: 12px 20px;
      border: none;
      background: #f8f9fa;
      color: #333;
      cursor: pointer;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.3s ease;
      border: 2px solid transparent;
      min-width: 120px;
    }

    .btn:hover {
      background: #667eea;
      color: white;
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
    }

    .btn-download {
      background: linear-gradient(45deg, #28a745, #20c997);
      color: white;
      font-weight: 600;
    }

    .btn-download:hover {
      background: linear-gradient(45deg, #218838, #1ba085);
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(40, 167, 69, 0.4);
    }

    .canvas-wrapper {
      text-align: center;
      margin-top: 20px;
    }

    #posterCanvas {
      border: 3px solid #dee2e6;
      border-radius: 15px;
      max-width: 100%;
      max-height: 70vh;
      touch-action: none;
      cursor: grab;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
      transition: all 0.3s ease;
    }

    #posterCanvas:active {
      cursor: grabbing;
    }

    .instructions {
      background: linear-gradient(45deg, #f8f9fa, #e9ecef);
      padding: 20px;
      border-radius: 15px;
      margin-bottom: 20px;
      border-left: 4px solid #667eea;
    }

    .instructions h3 {
      color: #333;
      margin-bottom: 10px;
      font-size: 1.2rem;
    }

    .instructions p {
      color: #666;
      line-height: 1.6;
      margin-bottom: 8px;
    }

    .status {
      text-align: center;
      padding: 10px;
      margin: 10px 0;
      border-radius: 10px;
      font-weight: 500;
    }

    .status.success {
      background: rgba(40, 167, 69, 0.1);
      color: #28a745;
      border: 1px solid rgba(40, 167, 69, 0.3);
    }

    .status.info {
      background: rgba(102, 126, 234, 0.1);
      color: #667eea;
      border: 1px solid rgba(102, 126, 234, 0.3);
    }

    @media (max-width: 768px) {
      .container {
        margin: 10px;
        padding: 20px;
      }

      h1 {
        font-size: 2rem;
      }

      .controls {
        flex-direction: column;
        align-items: center;
      }

      .btn {
        width: 200px;
      }
    }

    .loading {
      display: none;
      text-align: center;
      padding: 20px;
    }

    .spinner {
      border: 3px solid #f3f3f3;
      border-top: 3px solid #667eea;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      animation: spin 1s linear infinite;
      margin: 0 auto 10px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
<div class="container">
  <h1>üéí EDC Poster Generator</h1>

  <div class="instructions">
    <h3>How to use:</h3>
    <p>1. Upload your EDC (Every Day Carry) photo</p>
    <p>2. Drag to position, use controls to rotate and zoom</p>
    <p>3. Download your styled poster!</p>
  </div>

  <div class="upload-section">
    <div class="upload-wrapper">
      <input type="file" id="uploadImage" accept="image/*"/>
      <div class="upload-btn">üìÅ Choose Your EDC Photo</div>
    </div>
    <div id="status" class="status info" style="display: none;"></div>
  </div>

  <div class="loading" id="loading">
    <div class="spinner"></div>
    <p>Processing your image...</p>
  </div>

  <div class="controls">
    <button id="rotateLeft" class="btn">‚ü≤ Rotate Left</button>
    <button id="rotateRight" class="btn">‚ü≥ Rotate Right</button>
    <button id="zoomIn" class="btn">üîç+ Zoom In</button>
    <button id="zoomOut" class="btn">üîç- Zoom Out</button>
    <button id="resetBtn" class="btn">üîÑ Reset</button>
    <button id="downloadBtn" class="btn btn-download">üíæ Download Poster</button>
  </div>

  <div class="canvas-wrapper">
    <canvas id="posterCanvas"></canvas>
  </div>
</div>

<script>
  const canvas = document.getElementById("posterCanvas");
  const ctx = canvas.getContext("2d");
  const upload = document.getElementById("uploadImage");
  const downloadBtn = document.getElementById("downloadBtn");
  const status = document.getElementById("status");
  const loading = document.getElementById("loading");
  const uploadBtn = document.querySelector(".upload-btn");

  let userImg = null;
  let template = new Image();
  template.crossOrigin = "anonymous";
  template.src = "https://i.postimg.cc/gk7j0nn5/EDC-Template-1.png";

  // Transformation state
  let imgX = 0, imgY = 0;
  let imgScale = 1, imgRotation = 0;
  let isDragging = false, dragStartX, dragStartY;
  let initialScale = 1;

  // Show status message
  function showStatus(message, type = 'info') {
    status.textContent = message;
    status.className = `status ${type}`;
    status.style.display = 'block';
    setTimeout(() => {
      status.style.display = 'none';
    }, 3000);
  }

  // Draw everything
  function draw() {
    if (!template.complete) return;

    ctx.clearRect(0, 0, canvas.width, canvas.height);

    if (userImg && userImg.complete) {
      ctx.save();
      ctx.translate(imgX, imgY);
      ctx.rotate(imgRotation);
      ctx.scale(imgScale, imgScale);
      ctx.drawImage(userImg, -userImg.width/2, -userImg.height/2);
      ctx.restore();
    }

    // Draw template ALWAYS on top
    ctx.drawImage(template, 0, 0, canvas.width, canvas.height);
  }

  // Load template and set canvas size
  template.onload = () => {
    canvas.width = template.width;
    canvas.height = template.height;
    draw();
    showStatus("Template loaded! Upload your EDC photo to get started.", 'success');
  };

  template.onerror = () => {
    showStatus("Error loading template. Please refresh the page.", 'error');
  };

  // Calculate optimal scale for uploaded image
  function calculateInitialScale(img) {
    const maxWidth = canvas.width * 0.8;
    const maxHeight = canvas.height * 0.8;
    const scaleX = maxWidth / img.width;
    const scaleY = maxHeight / img.height;
    return Math.min(scaleX, scaleY);
  }

  // Upload image handler
  upload.addEventListener("change", (e) => {
    const file = e.target.files[0];
    if (!file) return;

    // Validate file type
    if (!file.type.startsWith('image/')) {
      showStatus("Please select a valid image file.", 'error');
      return;
    }

    // Validate file size (max 10MB)
    if (file.size > 10 * 1024 * 1024) {
      showStatus("Image too large. Please choose a file under 10MB.", 'error');
      return;
    }

    loading.style.display = 'block';
    uploadBtn.textContent = "Processing...";

    const reader = new FileReader();
    reader.onload = (ev) => {
      userImg = new Image();
      userImg.src = ev.target.result;
      userImg.onload = () => {
        // Center and scale the image appropriately
        imgX = canvas.width / 2;
        imgY = canvas.height / 2;
        initialScale = calculateInitialScale(userImg);
        imgScale = initialScale;
        imgRotation = 0;

        draw();
        loading.style.display = 'none';
        uploadBtn.textContent = "üìÅ Choose Your EDC Photo";
        showStatus("Image uploaded successfully! Drag to position, use controls to adjust.", 'success');
      };
      userImg.onerror = () => {
        loading.style.display = 'none';
        uploadBtn.textContent = "üìÅ Choose Your EDC Photo";
        showStatus("Error loading image. Please try a different file.", 'error');
      };
    };
    reader.readAsDataURL(file);
  });

  // Mouse events
  canvas.addEventListener("mousedown", (e) => {
    if (!userImg) return;
    isDragging = true;
    const rect = canvas.getBoundingClientRect();
    dragStartX = e.clientX - rect.left - imgX;
    dragStartY = e.clientY - rect.top - imgY;
    canvas.style.cursor = 'grabbing';
  });

  canvas.addEventListener("mousemove", (e) => {
    if (isDragging && userImg) {
      const rect = canvas.getBoundingClientRect();
      imgX = e.clientX - rect.left - dragStartX;
      imgY = e.clientY - rect.top - dragStartY;
      draw();
    }
  });

  canvas.addEventListener("mouseup", () => {
    isDragging = false;
    canvas.style.cursor = 'grab';
  });

  canvas.addEventListener("mouseleave", () => {
    isDragging = false;
    canvas.style.cursor = 'grab';
  });

  // Touch events
  canvas.addEventListener("touchstart", (e) => {
    e.preventDefault();
    if (!userImg) return;
    const touch = e.touches[0];
    const rect = canvas.getBoundingClientRect();
    isDragging = true;
    dragStartX = touch.clientX - rect.left - imgX;
    dragStartY = touch.clientY - rect.top - imgY;
  });

  canvas.addEventListener("touchmove", (e) => {
    e.preventDefault();
    if (isDragging && userImg) {
      const touch = e.touches[0];
      const rect = canvas.getBoundingClientRect();
      imgX = touch.clientX - rect.left - dragStartX;
      imgY = touch.clientY - rect.top - dragStartY;
      draw();
    }
  });

  canvas.addEventListener("touchend", (e) => {
    e.preventDefault();
    isDragging = false;
  });

  // Control buttons
  document.getElementById("rotateLeft").addEventListener("click", () => {
    if (!userImg) return;
    imgRotation -= Math.PI / 12; // 15 degrees
    draw();
  });

  document.getElementById("rotateRight").addEventListener("click", () => {
    if (!userImg) return;
    imgRotation += Math.PI / 12; // 15 degrees
    draw();
  });

  document.getElementById("zoomIn").addEventListener("click", () => {
    if (!userImg) return;
    imgScale *= 1.1;
    draw();
  });

  document.getElementById("zoomOut").addEventListener("click", () => {
    if (!userImg) return;
    imgScale *= 0.9;
    draw();
  });

  document.getElementById("resetBtn").addEventListener("click", () => {
    if (!userImg) return;
    imgX = canvas.width / 2;
    imgY = canvas.height / 2;
    imgScale = initialScale;
    imgRotation = 0;
    draw();
    showStatus("Image reset to original position and size.", 'info');
  });

  downloadBtn.addEventListener("click", () => {
    if (!userImg) {
      showStatus("Please upload an image first!", 'error');
      return;
    }

    try {
      // Create an offscreen canvas with full template size
      const offCanvas = document.createElement("canvas");
      offCanvas.width = template.width;
      offCanvas.height = template.height;
      const offCtx = offCanvas.getContext("2d");

      // Draw user image with same transformations
      if (userImg.complete) {
        offCtx.save();
        offCtx.translate(imgX, imgY);
        offCtx.rotate(imgRotation);
        offCtx.scale(imgScale, imgScale);
        offCtx.drawImage(userImg, -userImg.width/2, -userImg.height/2);
        offCtx.restore();
      }

      // Draw template on top
      offCtx.drawImage(template, 0, 0, offCanvas.width, offCanvas.height);

      // Download full image
      const link = document.createElement("a");
      const timestamp = new Date().toISOString().slice(0, 19).replace(/[:]/g, '-');
      link.download = `EDC_poster_${timestamp}.png`;
      link.href = offCanvas.toDataURL("image/png", 1.0);
      link.click();

      showStatus("Poster downloaded successfully!", 'success');
    } catch (error) {
      showStatus("Error downloading poster. Please try again.", 'error');
    }
  });


  // Keyboard shortcuts
  document.addEventListener("keydown", (e) => {
    if (!userImg) return;

    switch(e.key) {
      case 'ArrowLeft':
        imgX -= 5;
        draw();
        break;
      case 'ArrowRight':
        imgX += 5;
        draw();
        break;
      case 'ArrowUp':
        imgY -= 5;
        draw();
        break;
      case 'ArrowDown':
        imgY += 5;
        draw();
        break;
      case '=':
      case '+':
        imgScale *= 1.05;
        draw();
        break;
      case '-':
        imgScale *= 0.95;
        draw();
        break;
      case 'r':
        imgRotation += Math.PI / 24; // 7.5 degrees
        draw();
        break;
      case 'l':
        imgRotation -= Math.PI / 24; // 7.5 degrees
        draw();
        break;
    }
  });
</script>
</body>
</html>
